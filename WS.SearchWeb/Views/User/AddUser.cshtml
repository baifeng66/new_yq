@{ 
    ViewData["Title"] = "添加用户";
    ViewData["group"] = "用户管理";
    ViewData["groupurl"] = "/user/index"; 
}
<style>
    .required{
        color: red;
    }
     .layui-fluid{
        padding-top: 10px;
    }
    .layui-form-label{
        width: 118px;
        padding-right: 0;
        padding-left: 0;
    }
    .layui-input-block{
        margin-left: 141px;
    }
</style>
<form class="layui-form" action="">
    <div class="layui-fluid">
        <div class="layui-form-item">
            <label class="layui-form-label">用户名：<span class="required">*</span></label>
            <div class="layui-input-block">
                <input id="txtName" type="text" class="layui-input" lay-verify="required" placeholder="请输入用户名">                                   
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">真实姓名：</label>
            <div class="layui-input-block">
                <input id="txtTrueName" type="text" class="layui-input" placeholder="请输入真实姓名">                                   
            </div>
        </div>
        <div class="layui-form-item" id="code-box">
            <label class="layui-form-label">密码：<span class="required">*</span></label>
            <div class="layui-input-block">
                <input id="txtCode" type="password" class="layui-input" lay-verify="pwd" placeholder="请输入密码" >
                <div class="icon-css-view" style="width: 40px;height: 40px;top: 7px;right: 0px;text-align: center;position: absolute;">
                    <i id="iconShowView" class="layui-icon layui-icon-face-smile" style="color: lawngreen;"></i>
                    <i id="iconHiddenView" class="layui-icon layui-icon-face-cry" style="color: orangered;" hidden></i>
                </div>                                
            </div>
        </div>
        <div class="layui-form-item" id="pwd-box">
            <label class="layui-form-label">确认密码：<span class="required">*</span></label>
            <div class="layui-input-block">
                <input id="txtCode1" type="password" class="layui-input" lay-verify="pwd" placeholder="请再输入一遍密码">
                <div class="icon-css-view" style="width: 40px;height: 40px;top: 7px;right: 0px;text-align: center;position: absolute;">
                    <i id="iconShowView1" class="layui-icon layui-icon-face-smile" style="color: lawngreen;"></i>
                    <i id="iconHiddenView1" class="layui-icon layui-icon-face-cry" style="color: orangered;" hidden></i>
                </div>                               
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">角色：<span class="required">*</span></label>
            <div class="layui-input-block">
                <select id="txtRole" name="selectPlatform" lay-verify="required" lay-search></select>                               
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">手机号：</label>
            <div class="layui-input-block">
                <input id="txtTel" type="text" class="layui-input" placeholder="请输入手机号">                                   
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-label">状态：<span class="required">*</span></label>
            <div class="layui-input-block">
                <input type="radio" id="open" name="qtshow" value="1" title="启用" checked>
                <input type="radio" id="close" name="qtshow" value="0" title="禁用">
            </div>
        </div>
        
        <br />
        <div class="bottom layui-form-item" style="text-align: center;">
            <div class="button-container">
                <button type="submit" class="layui-btn layui-btn-normal layui-btn-sm1" lay-submit="" lay-filter="user-add" style="width: 60px;">
                    <font size="2">确认</font>
                </button>
                <button type="button" class="layui-btn layui-btn-primary layui-btn-sm1" style="width: 60px;" onclick="closeLayer();">取消</button>
            </div>
        </div>
    </div>
</form>
<script src="~/js/jquery.md5.js"></script>

<script>layui.use(['form', 'jquery'], function () {
        let form = layui.form;
        let $ = layui.jquery;

        //解决input回车页面刷新
        $(document).keydown(function (event) {
            if (event.keyCode == 13) {
                $("*").blur();
            }
        });

        form.verify({
            pwd: [
                /^[\S]{6,12}$/
                , '密码必须6到12位，且不能出现空格'
            ],
            pwd: function (value) {
                if (value.length < 6) {
                    return "密码必须大于6位数";
                }
                var lv = 0;
                if (value.match(/[a-z]/g)) { ++lv; }
                if (value.match(/[0-9]/g)) { ++lv; }
                if (value.match(/(.[^a-z0-9])/g)) { ++lv; }
                if (value.length < 6) { lv = 0; }
                if (lv < 3) {
                    return "密码强度不符合要求，需包含：字母、数字、特殊字符";
                }
            },
            phone: function (value) {
                if (value && !value.match(/(^$)|^1\d{10}$/)) {
                    return "手机号格式不正确";
                }
            },
        });
        var user_id = getParams("userId");
        $.GET("api/baseRole/listall", "", function (data, status, xhr) {
                if (data.code == 0) {
                    var role_data = data.data;
                    var options = "<option value='' selected>" + "请选择" + "</option>";
                    for (var i = 0; i < role_data.length; i++) {
                        var role_id = role_data[i].roleId;
                        var role_name = role_data[i].roleName;
                        options += "<option value='" + role_id + "'>" + role_name + "</option>";
                    }

                    $("#txtRole").html(options);
                    if (user_id) {
                        $("#txtRole").val(rid);
                        form.render("select");
            
                    }
                    form.render();
                } else {
                    layer.alert(data.msg);
                }
         });
        
        // 获取传参
        //var template = getParams("template");
        //if (template != 1) {
        //    $("#role-box").hide();
        //}
        
        if (user_id) {
            //$("#txtTrueName").attr("disabled", true);
            $("#code-box").remove();
            $("#pwd-box").remove();

            var loginName = getParams("loginName");
            var trueName = getParams("trueName");
            var loginPwd = getParams("loginPwd");
            var rid = getParams("rid");
            var phoneNum = getParams("phoneNum");         
            var state = getParams("state");
            var pos;


            // 填充
            $("#txtTrueName").val(trueName);
            $("#txtName").val(loginName);
            
            //$("#test30").val(create_time);
            //$("#txtCode").val(password);
            //$("#test33").val(use_time);
            $("#txtTel").val(phoneNum);


            if (state == "1") {
                console.log(state);
                $("#open").prop("checked", true);
                form.render();
            }
            else if (state == "0") {
                console.log(state);
                $("#close").prop("checked", true);
                form.render();
            }

            //console.log($('input:radio[name="qtshow"]:checked').val());

            form.render();
        }
        var password2 = $("#txtCode");
        var password1 = $("#txtCode1");
        $("#iconShowView").on('click', function (e) {
            console.log("smile");
            password2[0].type = "text";
            $("#iconShowView")[0].hidden = true;
            $("#iconHiddenView")[0].hidden = false;
            form.render();
        });
        $("#iconHiddenView").on('click', function (e) {
            console.log("cry");
            password2[0].type = "password";
            $("#iconShowView")[0].hidden = false;
            $("#iconHiddenView")[0].hidden = true;
            form.render();
        });

        $("#iconShowView1").on('click', function (e) {
            console.log("smile");
            password1[0].type = "text";
            $("#iconShowView1")[0].hidden = true;
            $("#iconHiddenView1")[0].hidden = false;
            form.render();
        });
        $("#iconHiddenView1").on('click', function (e) {
            console.log("cry");
            password1[0].type = "password";
            $("#iconShowView1")[0].hidden = false;
            $("#iconHiddenView1")[0].hidden = true;
            form.render();
        });

        $("#txtCode1").blur(function (event) {
            let pwd1 = $("#txtCode").val();
            let pwd2 = $("#txtCode1").val();
            if (pwd1 !== pwd2) {
                alert("两次输入密码不一致！");
                //$("#txtCodetext").html('<span style="color: #f00;">两个密码不一致</span>');
                //let pwd3 = $(" ").val();
            } else {
                //alert("密码一致！");
                //$("#txtCode1text").html('<span style="color: #0c0;">正确</span>');
                let pwd3 = $("#txtCode").val();
            };

        });

        form.on('submit(user-add)', function (data) {
            var is_visible;
            if ($('input:radio[name="qtshow"]:checked').val() == "1") {
                is_visible = '1';
            }
            else {
                is_visible = '0';
            }
            console.log(is_visible);

            var url;
            let time = new Date();
            let nowTime = timestampToTime(time.toLocaleString('en-US',{hour12: false}).split(" "));
            if (user_id) {
                var param = {
                    userId: parseInt(user_id),
                    loginName: $("#txtName").val(),
                    trueName: $("#txtTrueName").val(),
                    loginPwd: '',  
                    createBy: parseInt(getParams("createBy")),
                    createTime: getParams("createTime"),
                    phoneNum: $("#txtTel").val(),
                    updateBy: parseInt(imt_uid),
                    updateTime: nowTime,
                    rid: parseInt($("#txtRole").val()) ,
                    state: is_visible,               
                    lastLoginTime:'',
                };
                url = ApiBaseUrl + 'api/userInfo/edit';
            }
            else {
                var param = {      
                    userId: 0,
                    loginName: $("#txtName").val(),
                    trueName: $("#txtTrueName").val(),
                    loginPwd: $("#txtCode").val(),/*$.md5($("#txtCode").val()),       */            
                    phoneNum: $("#txtTel").val(),
                    createBy: parseInt(imt_uid),
                    createTime: nowTime,
                    updateBy: parseInt(imt_uid),
                    updateTime: nowTime,
                    rid: parseInt($("#txtRole").val()),
                    state: is_visible, 
                    lastLoginTime:nowTime,
                };
                url = ApiBaseUrl + 'api/userInfo/add';
            }

            

            $.ajax({
                url: url,
                data: JSON.stringify(param),
                dataType: 'json',
                contentType: 'application/json',
                type: 'post',
                beforeSend: function (request) {
                    request.setRequestHeader("Authorization", "Bearer " + imt_token);
                    request.setRequestHeader("uid", imt_uid);
                },
                success: function (responseJSON) {
                    if (responseJSON.code == 0) {
                        layer.msg(responseJSON.msg, { icon: 1, time: 1500 }, function () {
                            parent.layui.table.reload("user");
                            parent.layer.close(parent.layer.getFrameIndex(window.name));
                        });
                    }
                    else if (responseJSON.code == 1) {
                        layer.msg(responseJSON.msg, { icon: 2, time: 1500 });
                    }
                }
            })
            return false;
        });
    });

    function timestampToTime(times) {
        var checkTime = function (i) {
            if (i < 10) {
                i = "0" + i;
            }
            return i;
        }
        let time = times[1]
        let mdy = times[0]
        mdy = mdy.split('/')
        let month = parseInt(mdy[0]);
        month = checkTime(month);
        let day = parseInt(mdy[1]);
        day = checkTime(day);
        let year = parseInt(mdy[2])
        return year + '-' + month + '-' + day + ' ' + time
    }


    function closeLayer() {
        var index = parent.layer.getFrameIndex(window.name); //先得到当前iframe层的索引
        parent.layer.close(index); //再执行关闭
    }

    //获取参数
    function getParams(param_id) {
        var query = decodeURI(window.location.href).split("?")
        query.shift();      
        for (var i = 0; i < query.length; i++) {
            var pair = query[i].split("=");
            if (pair[0] == param_id) {
                return pair[1];
            }
        }
    }
    //修改参数
    function replaceParams(Pname, NewVal) {
        var ori_Url = this.location.href.toString();
        var reg = eval('/(' + Pname + '=)([^&]*/gi');
        var new_Url = ori_Url.replace(reg, Pname + '=' + NewVal);
        this.location = new_Url;
        return new_Url;
    }</script>
<script>
    layui.use('laydate', function () {
        var laydate = layui.laydate;

        laydate.render({
            elem: '#test33'
            , trigger: 'click'
            //, click: 'trigger'
            , type: 'datetime'
            , theme: '#393D49'
            , min: getNowFormatDate()
        });

    function getNowFormatDate() {
        var date = new Date();
        var seperator1 = "-";
        var seperator2 = ":";
        var month = date.getMonth() + 1;
        var strDate = date.getDate();
        if (month >= 1 && month <= 9) {
            month = "0" + month;
        }
        if (strDate >= 0 && strDate <= 9) {
            strDate = "0" + strDate;
        }
        var currentdate = date.getFullYear() + seperator1 + month + seperator1 + strDate +
            " " + date.getHours() + seperator2 + date.getMinutes() +
            seperator2 + date.getSeconds();
        return currentdate;
    }
    });
    </script>
