@{
    ViewData["Title"] = "权限框架";
}
<style>
    body {
        margin-bottom: 60px;
    }

    .layui-nav-tree .layui-nav-child dd.layui-this, .layui-nav-tree .layui-nav-child dd.layui-this a, .layui-nav-tree .layui-this, .layui-nav-tree .layui-this > a, .layui-nav-tree .layui-this > a:hover, .layui-nav .layui-nav-child dd.layui-this a, .layui-nav-child dd.layui-this {
        background-color: #1E9FFF;
        background-color: #1E9FFF;
    }

    .layui-tab {
        margin: 0px 0;
        height: 100%;
    }

    .layui-tab-content {
        height: calc(98%);
        height: calc(100% - 50px);
        height: -moz-calc(100% - 50px);
        height: -webkit-calc(100% - 50px);
    }

    .layui-table, .layui-table-view {
        margin: 0px 0;
    }

    .layui-tab-item {
        height: 100%;
    }

    .layui-layout-admin .layui-body {
        margin: 0;
    }

    .layui-nav-item > a {
        font-weight: 600;
    }

    .layui-nav-item a .layui-icon {
        margin-right: 10px;
    }

    .layui-bg-black, .layui-nav {
        background-color: #23262e !important;
    }

    .layui-nav-tree .layui-nav-bar, .layui-nav-bar {
        background-color: #1E9FFF;
    }

    .layui-nav-tree .layui-nav-child a {
        padding-left: 50px;
    }

    #iframeMain {
        width: 100%;
    }
</style>
<div class="layui-layout layui-layout-admin">
    <div class="layui-header header" winter="">
        <div class="layui-main">
            <div class="name">
                权限框架
            </div>
            <ul class="layui-nav layui-layout-right">
                <li class="layui-nav-item" lay-unselect="">
                    <a href="javascript:;">
                        <i class="layui-icon layui-icon-user"></i>
                        <cite id="username"></cite>
                    </a>
                    <dl class="layui-nav-child user">
                        @*<dd><a href="#" style="text-align: center;" onclick="showinfo();">基本资料</a></dd>*@
                        <dd><a href="#" style="text-align: center;" onclick="changepwd();">修改密码</a></dd>
                        <dd><a href="#" style="text-align: center;" onclick="loginout();">注销登录</a></dd>
                    </dl>
                </li>
            </ul>
            @*<div class="logout" onclick="loginout()">
            <i class="layui-icon layui-icon-logout "></i>
            <span>退出</span>
            </div> *@
        </div>
    </div>
    @*左侧导航*@
    <div class="layui-side layui-bg-black">
        <div class="layui-side-scroll">
            <ul class="layui-nav layui-nav-tree" lay-filter="test" id="laymenu">
                @* <li id="nav-index" class="layui-nav-item">
                <a href="javascript:;">
                <i class="layui-icon layui-icon-read"></i>
                <cite>内容管理</cite>
                <span class="layui-nav-more"></span>
                </a>
                <dl class="layui-nav-child">
                <dd><a href="../Case/Index" data-id="2" target="content_iframe">案件管理</a></dd>
                <dd><a href="../Dictionary/Index" data-id="4" target="content_iframe">字典管理</a></dd>
                </dl>
                </li>     *@
            </ul>
        </div>
    </div>
    <div class="layui-body">
        <iframe id="iframeMain" name="content_iframe" src="" onload="changeFrameHeight()" scrolling="auto" frameborder="0"></iframe>
    </div>
    @*<div class="layui-body">
    <div class="layui-tab layui-tab-card" lay-filter="pageframe" lay-allowClose="true">
    <ul class="layui-tab-title">
    <li class="layui-this" lay-id="67">首页</li>
    </ul>
    <div class="layui-tab-content">
    <div class="layui-tab-item layui-show">
    <iframe src="../CaseSearch/Index" scrolling="auto" frameborder="0" id="mainframe0" style="width:100%;height:100%" width="100%" height="100%">  </iframe>
    *@
    @*<iframe src="/home/homeindex" scrolling="auto" frameborder="0" id="mainframe0" style="width:100%;height:100%" width="100%" height="100%">  </iframe>*@
    @* </div>
    </div>
    </div>
    </div>

    <img id="showimginfo" src="" img-url="" style="display:none;" />*@

    @*<div id="mm" class="" style="width: 150px;position:absolute">
    <div id="mm-tabclose">
    关闭当前
    </div>
    <div id="mm-tabcloseall">
    全部关闭
    </div>
    <div id="mm-tabcloseother">
    除此之外全部关闭
    </div>
    <div id="mm-tabcancel">
    取消
    </div>
    </div>*@
</div>

@section scripts
    {
    <script>
        var element;
        layui.use(['layer', 'form', 'element'], function () {
            var layer = layui.layer;
            form = layui.form;
            element = layui.element;
            $.GET("api/basemenu/usermenu", "", function (data) {
                if (data.code == 0) {
                    if (data.count > 0) {
                        if (data.data[0].menuUrl && data.data[0].menuUrl != "#") {
                            document.getElementById("iframeMain").src = data.data[0].menuUrl;
                        } else if (data.data[0].children && data.data[0].children.length > 0 && data.data[0].children[0].menuUrl!="#") {
                            document.getElementById("iframeMain").src = data.data[0].children[0].menuUrl;
                        }
                        var str = "";
                        $.each(data.data, function (index, value) {
                            if (value.children && value.children.length > 0) {
                                str += " <li id='" + value.menuId + "' class=\"layui-nav-item \"><a href=\"javascript:void(0)\"  ><i class=\"layui-icon " + value.menuIcon + "\"></i><cite>" + value.menuName + "</cite></a>";
                                str += "<dl class=\"layui-nav-child\">";
                                $.each(value.children, function (index1, value1) {
                                    str += "<dd><a  href=\"" + value1.menuUrl + "\" target=\"content_iframe\">" + value1.menuName + "</a></dd>";
                                });
                                str += "</dl>";
                            } else {
                                str += " <li id='" + value.menuId + "' class=\"layui-nav-item \"><a href=\"" + value.menuUrl + "\"  target=\"content_iframe\"><i class=\"layui-icon " + value.menuIcon + "\"></i><cite>" + value.menuName + "</cite></a>";
                            }
                            str += "</li>";
                        });
                        $("#laymenu").html(str);
                        element.render('nav');

                    } else {
                        layer.alert("无权限");
                    }
                } else if (data.code == 100) {
                    //loginout();
                } else {
                    layer.alert(data.msg);
                }
            });

            $.GET("api/userInfo/getCurrentUser", "", function (data) {
                if (data.code == 0) {
                    sessionStorage.setItem("imt_pwd", data.data.loginPwd);
                    if (data.data.truename) {
                        $("#username").text(data.data.trueName);
                    } else {
                        $("#username").text(data.data.loginName);
                    }
                    //localStorage.setItem("imt_userinfo", JSON.stringify(data.data));
                } else {
                    layer.alert(data.msg);
                }
            });
            //var active = {
            //    tabAdd: function (name, src, id) {
            //        var content = " <iframe src=\"" + src + "\" scrolling=\"auto\" frameborder=\"0\" id=\"mainframe" + id + "\" style=\"width: 100%; height: 100%\" width=\"100%\" height=\"100%\"> </iframe>";
            //        //新增一个Tab项
            //        element.tabAdd('pageframe', {
            //            title: name
            //            , content: content
            //            , id: id
            //        });
            //        bindContextMenu();
            //    }
            //}

            //$("#laymenu").on("click", "a", function () {
            //    var url = $(this).attr("data-url");
            //    var name = $(this).attr("data-name");
            //    var id = $(this).attr("data-id");
            //    if (url != "#") {
            //        //避免重复添加
            //        var exist = $(".layui-tab li[lay-id='" + id + "']").length;
            //        if (exist < 1) {
            //            active.tabAdd(name, url, id);
            //        }

            //        element.tabChange('pageframe', id);
            //    }
            //});
            //bindContextMenu();

            //$(".layui-tab-content").height($(".layui-body").height() - 50);

            //$(window).resize(function () {
            //    $(".layui-tab-content").height($(".layui-body").height() - 50);
            //});
        });


        function refreshIframe() {
            document.getElementById("iframeMain").contentWindow.location.reload(true);
        }

        function changeFrameHeight() {
            var ifm = document.getElementById("iframeMain");

            ifm.height = document.documentElement.clientHeight - 60;
        }

        window.onresize = function () {
            changeFrameHeight();
        }
        //修改密码
        function changepwd() {
            layer.open({
                type: 2, //1.html,2.iframe
                offset: 'auto',
                area: ['600px', '400px'],
                title: ["修改密码"],
                content: "/home/changepwd",
                end: function () {
                    $(".user").children("dd").removeClass("layui-this")
                },
            });
        }
        //退出登录
        function loginout() {
            sessionStorage.removeItem("imt_token")
            location.href = "/home/login";
        }
        //获取参数
        function getParams(param_id) {
            var query = decodeURI(window.location.href).split("?")
            query.shift();      
            for (var i = 0; i < query.length; i++) {
                var pair = query[i].split("=");
                if (pair[0] == param_id) {
                    return pair[1];
                }
            }
        }


    </script>
}
